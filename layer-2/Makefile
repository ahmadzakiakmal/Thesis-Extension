.PHONY: build start stop clean test logs

# Build Docker images
build:
	@echo "ğŸ”¨ Building L2 Shard Docker image..."
	docker build -t l2-shard:latest .
	@echo "âœ… Build complete!"

# Start L2 shards
start:
	@echo "ğŸš€ Starting L2 Shards..."
	docker-compose up -d
	@echo "âœ… L2 Shards started!"
	@echo ""
	@echo "ğŸ“ Shard A (Group A): http://localhost:6000"
	@echo "ğŸ“ Shard B (Group B): http://localhost:6001"
	@echo ""
	@echo "Run 'make logs' to view logs"

# Stop L2 shards
stop:
	@echo "ğŸ›‘ Stopping L2 Shards..."
	docker-compose down
	@echo "âœ… L2 Shards stopped!"

# Clean everything (including volumes)
clean:
	@echo "ğŸ§¹ Cleaning up L2 Shards..."
	docker-compose down -v
	docker rmi l2-shard:latest 2>/dev/null || true
	@echo "âœ… Cleanup complete!"

# View logs
logs:
	docker-compose logs -f

# Test L2 shard endpoints
test:
	@echo "ğŸ§ª Testing L2 Shard A..."
	@echo ""
	@echo "1. Testing /info endpoint..."
	@curl -s http://localhost:6000/info | jq '.' || echo "âŒ Failed"
	@echo ""
	@echo "2. Creating session..."
	@curl -s -X POST http://localhost:6000/session/start \
		-H "Content-Type: application/json" \
		-d '{"operator_id":"OPR-001"}' | jq '.' || echo "âŒ Failed"
	@echo ""
	@echo "âœ… Basic tests complete!"

# Full workflow test
test-workflow:
	@echo "ğŸ§ª Running full workflow test on Shard A..."
	@bash test-workflow.sh

# Restart
restart: stop start

# Build and start
run: build start